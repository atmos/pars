! Configuration File for keepalived
! Note: Max of 20 ips per vrrp_instance. It's a limitation of the VRRP protocol

global_defs {
   #notification_email {
   #  # Add e-mail notifications
   #}
   #notification_email_from info@engineyard.com
   #smtp_server 192.168.200.1
   #smtp_connect_timeout 30
   lvs_id nr00-gw00
}

vrrp_sync_group NR00_LBA {
  group {
    NR00_LBA_INT
    NR00_LBA_EXT1
 }
}

vrrp_instance NR00_LBA_INT {
    state MASTER
    interface external
    lvs_sync_daemon_interface internal
    virtual_router_id 50
    priority 100
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.0.0.60 dev internal
        10.0.0.67 dev internal # mail internal
    }
}

vrrp_instance NR00_LBA_EXT1 {
    state MASTER
    interface external
    lvs_sync_daemon_interface internal
    virtual_router_id 51
    priority 100
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
      65.74.175.196 dev external # failover address
      65.74.177.193 dev external # outbound smtp address
      65.74.177.194 dev external # UI
      65.74.177.195 dev external # collector
      65.74.177.196 dev external # corporate website
      65.74.177.197 dev external # nagios
      65.74.177.198 dev external # nagios
      65.74.177.199 dev external # qa
    }
}

#UP production slices
virtual_server 65.74.177.194 80 {
  sorry_server 127.0.0.1 80
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  virtualhost rpm.newrelic.com
  real_server 10.0.192.13 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.14 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.15 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.16 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#UP production slices 443
virtual_server 65.74.177.194 443 {
  sorry_server 127.0.0.1 443
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  virtualhost rpm.newrelic.com
  real_server 10.0.192.13 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.14 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.15 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.16 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#collector production slices
virtual_server 65.74.177.195 80 {
  sorry_server 127.0.0.1 80
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  virtualhost collector.newrelic.com
  real_server 10.0.192.17 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.18 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.19 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.20 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.21 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.22 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.23 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.24 80 {
    weight 1
    HTTP_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#collector production slices 443
virtual_server 65.74.177.195 443 {
  sorry_server 127.0.0.1 443
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  virtualhost collector.newrelic.com
  real_server 10.0.192.17 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.18 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.19 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.20 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.21 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.22 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.23 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.24 443 {
    weight 1
    SSL_GET {
      url {
        path /status/mongrel
        status_code 200
      }
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#newrelic corporate website
virtual_server 65.74.177.196 80 {
  sorry_server 127.0.0.1 80
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.25 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.26 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#newrelic staging
virtual_server 65.74.177.198 80 {
  sorry_server 127.0.0.1 80
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.27 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#newrelic staging 443
virtual_server 65.74.177.198 443 {
  sorry_server 127.0.0.1 443
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.27 443 {
    weight 1
    TCP_CHECK {
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#newrelic qa
virtual_server 65.74.177.199 80 {
  sorry_server 127.0.0.1 80
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.28 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}


#smtp-outgoing
virtual_server 10.0.0.67 25 {
    delay_loop 6
    lb_algo lc
    lb_kind NAT
    nat_mask 255.255.255.0
    persistence_timeout 0
    protocol TCP
    real_server 10.0.192.10 25 {
        TCP_CHECK {
            connect_port 25
            connect_timeout 2
            nb_get_retry 20
            delay_before_retry 2
        }
    }
    real_server 10.0.192.11 25 {
        TCP_CHECK {
            connect_port 25
            connect_timeout 2
            nb_get_retry 20
            delay_before_retry 2
        }
    }
}

# nagios
virtual_server 65.74.177.197 80 {
  sorry_server 127.0.0.1 80
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.12 80 {
    weight 1
    TCP_CHECK { 
      connect_port 80
      connect_timeout 2
      nb_get_retry 20  
      delay_before_retry 2
    }
  }
}
	
# build slice
virtual_server 65.74.175.196 7999 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP
	real_server 10.0.255.1 22 {
	}
}

# n00
virtual_server 65.74.175.196 7000 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP
	real_server 10.0.0.1 22 {
	}
}

# n01
virtual_server 65.74.175.196 7001 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP
	real_server 10.0.0.2 22 {
	}
}

# n02
virtual_server 65.74.175.196 7002 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP
	real_server 10.0.0.3 22 {
	}
}

# n03
virtual_server 65.74.175.196 7003 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP
	real_server 10.0.0.4 22 {
	}
}




#nr00-s00000 ssh
virtual_server 65.74.175.196 8000 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.1 22 {
  }
}


#nr00-s00001 ssh
virtual_server 65.74.175.196 8001 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.2 22 {
  }
}


#nr00-s00002 ssh
virtual_server 65.74.175.196 8002 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.3 22 {
  }
}


#nr00-s00003 ssh
virtual_server 65.74.175.196 8003 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.4 22 {
  }
}


#nr00-s00004 ssh
virtual_server 65.74.175.196 8004 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.5 22 {
  }
}


#nr00-s00005 ssh
virtual_server 65.74.175.196 8005 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.6 22 {
  }
}


#nr00-s00006 ssh
virtual_server 65.74.175.196 8006 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.7 22 {
  }
}


#nr00-s00007 ssh
virtual_server 65.74.175.196 8007 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.8 22 {
  }
}


#nr00-s00008 ssh
virtual_server 65.74.175.196 8008 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.9 22 {
  }
}


#nr00-s00009 ssh
virtual_server 65.74.175.196 8009 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.10 22 {
  }
}


#nr00-s00010 ssh
virtual_server 65.74.175.196 8010 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.11 22 {
  }
}


#nr00-s00011 ssh
virtual_server 65.74.175.196 8011 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.12 22 {
  }
}


#nr00-s00012 ssh
virtual_server 65.74.175.196 8012 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.13 22 {
  }
}


#nr00-s00013 ssh
virtual_server 65.74.175.196 8013 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.14 22 {
  }
}


#nr00-s00014 ssh
virtual_server 65.74.175.196 8014 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.15 22 {
  }
}


#nr00-s00015 ssh
virtual_server 65.74.175.196 8015 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.16 22 {
  }
}

#nr00-s00016 ssh
virtual_server 65.74.175.196 8016 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.17 22 {
  }
}

#nr00-s00017 ssh
virtual_server 65.74.175.196 8017 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.18 22 {
  }
}

#nr00-s00018 ssh
virtual_server 65.74.175.196 8018 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.19 22 {
  }
}

#nr00-s00019 ssh
virtual_server 65.74.175.196 8019 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.20 22 {
  }
}

#nr00-s00020 ssh
virtual_server 65.74.175.196 8020 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.21 22 {
  }
}

#nr00-s00021 ssh
virtual_server 65.74.175.196 8021 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.22 22 {
  }
}

#nr00-s00022 ssh
virtual_server 65.74.175.196 8022 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.23 22 {
  }
}

#nr00-s00023 ssh
virtual_server 65.74.175.196 8023 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.24 22 {
  }
}

#nr00-s00024 ssh
virtual_server 65.74.175.196 8024 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.25 22 {
  }
}

#nr00-s00025 ssh
virtual_server 65.74.175.196 8025 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.26 22 {
  }
}

#nr00-s00026 ssh
virtual_server 65.74.175.196 8026 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.27 22 {
  }
}

#nr00-s00027 ssh
virtual_server 65.74.175.196 8027 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.28 22 {
  }
}
