! Configuration File for keepalived
! Note: Max of 20 ips per vrrp_instance. It's a limitation of the VRRP protocol

global_defs {
   #notification_email {
   #  # Add e-mail notifications
   #}
   #notification_email_from Alexandre.Cassen@firewall.loc
   #smtp_server 192.168.200.1
   #smtp_connect_timeout 30
   lvs_id sa00-gw00
}

vrrp_sync_group SA00_LBA {
  group {
    SA00_LBA_INT
    SA00_LBA_EXT1
 }
}

vrrp_instance SA00_LBA_INT {
    state MASTER
    interface external
    lvs_sync_daemon_interface internal
    virtual_router_id 50
    priority 100
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.0.0.60 dev internal
        10.0.0.67 dev internal
        10.0.0.68 dev internal
        10.0.0.70 dev internal
    }
}

vrrp_instance SA00_LBA_EXT1 {
    state MASTER
    interface external
    lvs_sync_daemon_interface internal
    virtual_router_id 51
    priority 100
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
      65.74.181.68 dev external
    	65.74.170.161 dev external
    	65.74.170.162 dev external # Do not use, for smtp outbound mapping
    	65.74.170.163 dev external # staging
    	65.74.170.164 dev external # production
    	65.74.170.165 dev external # staging upload
    	65.74.170.166 dev external # production upload
    	65.74.170.167 dev external # nagios
#    	65.74.170.168 dev external # production testing (for GFS testing 2008-2-28)
	 #65.74.139.5 dev external
    }
}

#*.svn.sa00.seekingalpha.com
virtual_server 65.74.170.161 80 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.22 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

virtual_server 65.74.170.161 443 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.22 443 {
    weight 1
    TCP_CHECK {
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}


# internal smtp
virtual_server 10.0.0.67 25 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.19 25 {
    weight 1
    TCP_CHECK {
      connect_port 25
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.20 25 {
    weight 1
    TCP_CHECK {
      connect_port 25
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

# build slice
virtual_server 65.74.181.68 7999 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP
	real_server 10.0.255.1 22 {
	}
}

# n00
virtual_server 65.74.181.68 7000 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP

	real_server 10.0.0.1 22 {
	}
}

# n01
virtual_server 65.74.181.68 7001 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP

	real_server 10.0.0.2 22 {
	}
}

# n02
virtual_server 65.74.181.68 7002 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP

	real_server 10.0.0.3 22 {
	}
}

# n023
virtual_server 65.74.181.68 7003 {
	delay_loop 6
	lb_algo lc
	lb_kind NAT
	nat_mask 255.255.255.0
	persistence_timeout 0
	protocol TCP

	real_server 10.0.0.4 22 {
	}
}

#sa00-s00000 ssh
virtual_server 65.74.181.68 8000 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.1 22 {
  }
}


#sa00-s00001 ssh
virtual_server 65.74.181.68 8001 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.2 22 {
  }
}


#sa00-s00002 ssh
virtual_server 65.74.181.68 8002 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.3 22 {
  }
}


#sa00-s00003 ssh
virtual_server 65.74.181.68 8003 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.4 22 {
  }
}


#sa00-s00004 ssh
virtual_server 65.74.181.68 8004 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.5 22 {
  }
}


#sa00-s00005 ssh
virtual_server 65.74.181.68 8005 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.6 22 {
  }
}


#sa00-s00006 ssh
virtual_server 65.74.181.68 8006 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.7 22 {
  }
}


#sa00-s00007 ssh
virtual_server 65.74.181.68 8007 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.8 22 {
  }
}


#sa00-s00008 ssh
virtual_server 65.74.181.68 8008 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.9 22 {
  }
}


#sa00-s00009 ssh
virtual_server 65.74.181.68 8009 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.10 22 {
  }
}


#sa00-s00010 ssh
virtual_server 65.74.181.68 8010 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.11 22 {
  }
}


#sa00-s00011 ssh
virtual_server 65.74.181.68 8011 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.12 22 {
  }
}


#sa00-s00012 ssh
virtual_server 65.74.181.68 8012 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.13 22 {
  }
}


#sa00-s00013 ssh
virtual_server 65.74.181.68 8013 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.14 22 {
  }
}


#sa00-s00014 ssh
virtual_server 65.74.181.68 8014 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.15 22 {
  }
}


#sa00-s00015 ssh
virtual_server 65.74.181.68 8015 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.16 22 {
  }
}


#sa00-s00016 ssh
virtual_server 65.74.181.68 8016 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.17 22 {
  }
}


#sa00-s00017 ssh
virtual_server 65.74.181.68 8017 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.18 22 {
  }
}


#sa00-s00018 ssh
virtual_server 65.74.181.68 8018 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.19 22 {
  }
}


#sa00-s00019 ssh
virtual_server 65.74.181.68 8019 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.20 22 {
  }
}


#sa00-s00020 ssh
virtual_server 65.74.181.68 8020 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.21 22 {
  }
}


#sa00-s00021 ssh
virtual_server 65.74.181.68 8021 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.22 22 {
  }
}

#sa00-s00022 ssh
virtual_server 65.74.181.68 8022 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.23 22 {
  }
}

#sa00-s00023 ssh
virtual_server 65.74.181.68 8023 {
  delay_loop 30
  lb_algo lblcr
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.24 22 {
  }
}


#65.74.170.163 staging

virtual_server 65.74.170.163 80 {
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.11 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.12 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
# removed temporarily for testing
#  real_server 10.0.192.13 80 {
#    weight 1
#    TCP_CHECK {
#      connect_port 80
#      connect_timeout 2
#      nb_get_retry 20
#      delay_before_retry 2
#    }
  }
}

#65.74.170.165 staging upload

virtual_server 65.74.170.165 22 {
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.17 22 {
    weight 1
    TCP_CHECK {
      connect_port 22
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

virtual_server 65.74.170.163 443 {
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.11 443 {
    weight 1
    TCP_CHECK {
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.12 443 {
    weight 1
    TCP_CHECK {
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.13 443 {
    weight 1
    TCP_CHECK {
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#65.74.170.164 production

virtual_server 65.74.170.164 80 {
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.4 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.5 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.6 80 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

virtual_server 65.74.170.164 443 {
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.192.4 443 {
    weight 1
    TCP_CHECK {
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.5 443 {
    weight 1
    TCP_CHECK {
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
  real_server 10.0.192.6 443 {
    weight 1
    TCP_CHECK {
      connect_port 443
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#65.74.170.166 production upload

virtual_server 65.74.170.166 22 {
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.10 22 {
    weight 1
    TCP_CHECK {
      connect_port 22
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}

#65.74.170.167 nagios

virtual_server 65.74.170.167 80 {
  delay_loop 6
  lb_algo lc
  lb_kind NAT
  nat_mask 255.255.255.0
  persistence_timeout 0
  protocol TCP
  real_server 10.0.64.18 80 {
    weight 1
    TCP_CHECK {
      connect_port 80 
      connect_timeout 2
      nb_get_retry 20
      delay_before_retry 2
    }
  }
}
